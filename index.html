<html>
<head>
<script type="text/javascript" src="http://code.jquery.com/jquery-3.1.1.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css"
  integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js"
  integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"
  integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"
  integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
<style type="text/css">
input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button
  {
  -webkit-appearance: none;
  margin: 0;
}
</style>
</head>
<body>
  <div class="container">
    <div class="col-sm-14">
      <form class="form-horizontal">
        <fieldset>
          <legend><strong>Параметры помещения</strong></legend>
          <div class="form-group row">
            <label for="select-tp" class="col-3 col-form-label col-form-label-sm">Тип помещения</label>
            <div class="col-sm-2">
              <select id="select-tp" class="form-control form-control-sm" name="tipPom" required>
                <option value="" disabled selected>Выберите ...</option>
                <option value="tp1">Кухня, комната, коридор</option>
                <option value="tp2">Ванная, балкон, тамбур</option>
              </select>
            </div>
          </div>
          <div class="form-group row">
            <label for="select-to" class="col-3 col-form-label col-form-label-sm">Тип обогрева</label>
            <div class="col-sm-2">
              <select id="select-to" class="form-control form-control-sm" name="tipObo" required>
                <option value="" disabled selected>Выберите ...</option>
                <option value="to1">Комфортный</option>
                <option value="to2">Основной</option>
              </select>
            </div>
          </div>
          <div class="form-group row">
            <label for="input-a" class="col-3 col-form-label col-form-label-sm">Размер А</label>
            <div class="col-sm-2 input-group input-group-sm">
              <input type="number" class="form-control form-control-sm" id="input-a" name="a" min="1" step="0.01" required>
              <span class="input-group-addon">м</span>
            </div>
          </div>
          <div class="form-group row">
            <label for="input-b" class="col-3 col-form-label col-form-label-sm">Размер B</label>
            <div class="col-sm-2 input-group input-group-sm">
              <input type="number" class="form-control form-control-sm" id="input-b" name="b" min="1" step="0.01" required>
              <span class="input-group-addon">м</span>
            </div>
          </div>
          <div class="form-group row">
            <label for="input-a1" class="col-3 col-form-label col-form-label-sm">Размер А1</label>
            <div class="col-sm-2 input-group input-group-sm">
              <input type="number" class="form-control form-control-sm" id="input-a1" name="a1" min="0" step="0.01" max="100">
              <span class="input-group-addon">м</span>
            </div>
          </div>
          <div class="form-group row">
            <label for="input-b1" class="col-3 col-form-label col-form-label-sm">Размер B1</label>
            <div class="col-sm-2 input-group input-group-sm">
              <input type="number" class="form-control form-control-sm" id="input-b1" name="b1" min="0" step="0.01" max="100">
              <span class="input-group-addon">м</span>
            </div>
          </div>
          <div class="form-group row">
            <label for="input-S" class="col-3 col-form-label col-form-label-sm">Площадь теплого пола</label>
            <div class="col-sm-2 input-group input-group-sm">
              <input type="number" class="form-control form-control-sm" id="input-S" name="S" readonly>
              <span class="input-group-addon">м2</span>
            </div>
          </div>
          <div class="form-group row">
            <label for="input-P" class="col-3 col-form-label col-form-label-sm">Рекомендуемая мощность кабеля</label>
            <div class="col-sm-2 input-group input-group-sm">
              <input name="P" class="form-control form-control-sm" id="input-P" type="number" readonly>
              <span class="input-group-addon">Вт</span>
            </div>
          </div>
          <div class="form-group row">
            <label for="input-L" class="col-3 col-form-label col-form-label-sm">Длина кабеля</label>
            <div class="col-sm-2 input-group input-group-sm">
              <input name="L" class="form-control form-control-sm" id="input-L" type="number" readonly>
              <span class="input-group-addon">м</span>
            </div>
          </div>
          <div class="form-group row">
            <div class="col-sm-3"></div>
            <div class="col-sm-1 calculate-first">
              <button type="submit" class="btn btn-primary btn-sm">Рассчитать</button>
            </div>
            <div class="col-sm-1 reset">
              <button type="reset" class="btn btn-link btn-sm">Сброс</button>
            </div>
          </div>
        </fieldset>
      </form>
      <form class="form-horizontal">
        <fieldset>
          <legend><strong>Данные для монтажа ленты</strong></legend>
          <div class="form-group row">
            <label for="input-p1" class="col-3 col-form-label col-form-label-sm">Вынос кабеля за ленту</label>
            <div class="col-sm-2 input-group input-group-sm">
              <input name="p1" class="form-control form-control-sm" id="input-p1" type="number" readonly value="0.05">
              <span class="input-group-addon">м</span>
            </div>
          </div>
          <div class="form-group row">
            <label for="input-p2" class="col-3 col-form-label col-form-label-sm">Отступ ленты от линии А</label>
            <div class="col-sm-2 input-group input-group-sm">
              <input name="p2" class="form-control form-control-sm" id="input-p2" type="number" readonly value="0.15">
              <span class="input-group-addon">м</span>
            </div>
          </div>
          <div class="form-group row" style="display: none;">
            <label for="input-p3" class="col-3 col-form-label col-form-label-sm">Отступ ленты от линии С</label>
            <div class="col-sm-2 input-group input-group-sm">
              <input name="p3" class="form-control form-control-sm" id="input-p3" type="number" readonly value="0.05">
              <span class="input-group-addon">м</span>
            </div>
          </div>
          <div class="form-group row">
            <label for="input-p4" class="col-3 col-form-label col-form-label-sm">Число полос ленты</label>
            <div class="col-sm-2">
              <input name="p4" class="form-control form-control-sm" id="input-p4" type="number" readonly>
            </div>
          </div>
          <div class="form-group row">
            <label for="input-p5" class="col-3 col-form-label col-form-label-sm">Шаг укладки ленты</label>
            <div class="col-sm-2 input-group input-group-sm">
              <input name="p5" class="form-control form-control-sm" id="input-p5" type="number" readonly>
              <span class="input-group-addon">м</span>
            </div>
          </div>
        </fieldset>
        <fieldset>
          <legend><strong>Данные для монтажа кабеля</strong></legend>
          <div class="form-group row">
            <label for="input-q" class="col-3 col-form-label col-form-label-sm">Шаг укладки кабеля q</label>
            <div class="col-sm-2 input-group input-group-sm">
              <input name="q" class="form-control form-control-sm" id="input-q" type="number" step="0.001">
              <span class="input-group-addon">м</span>
            </div>
          </div>
          <div class="form-group row">
            <label for="input-k" class="col-3 col-form-label col-form-label-sm">Число полос кабеля k</label>
            <div class="col-sm-2">
              <input name="k" class="form-control form-control-sm" id="input-k" type="number" step="1">
            </div>
          </div>
          <div class="form-group row">
            <label for="input-k1" class="col-3 col-form-label col-form-label-sm">Число полос кабеля k1</label>
            <div class="col-sm-2">
              <input name="k1" class="form-control form-control-sm" id="input-k1" type="number" step="1">
            </div>
          </div>
          <div class="form-group row">
            <label for="input-l" class="col-3 col-form-label col-form-label-sm">Длина полосы кабеля l</label>
            <div class="col-sm-2 input-group input-group-sm">
              <input name="l" class="form-control form-control-sm" id="input-l" type="number" readonly>
              <span class="input-group-addon">м</span>
            </div>
          </div>
          <div class="form-group row">
            <label for="input-l1" class="col-3 col-form-label col-form-label-sm">Длина полосы кабеля l1</label>
            <div class="col-sm-2 input-group input-group-sm">
              <input name="l1" class="form-control form-control-sm" id="input-l1" type="number" readonly>
              <span class="input-group-addon">м</span>
            </div>
          </div>
          <div class="form-group row">
          <div class="col-sm-3"></div>
            <div class="col-sm-1 calculate-third">
              <button type="submit" class="btn btn-primary btn-sm">Пересчитать размеры</button>
            </div>
          </div>
        </fieldset>
        <fieldset>
          <legend><strong>Итоговые размеры теплого пола</strong></legend>
          <div class="form-group row">
            <label for="input-sizeA" class="col-3 col-form-label col-form-label-sm">Размер А</label>
            <div class="col-sm-2 input-group input-group-sm">
              <input name="sizeA" class="form-control form-control-sm" id="input-sizeA" type="text" readonly>
              <span class="input-group-addon">м</span>
            </div>
          </div>
          <div class="form-group row">
            <label for="input-sizeB" class="col-3 col-form-label col-form-label-sm">Размер B</label>
            <div class="col-sm-2 input-group input-group-sm">
              <input name="sizeB" class="form-control form-control-sm" id="input-sizeB" type="text" readonly>
              <span class="input-group-addon">м</span>
            </div>
          </div>
          <div class="form-group row">
            <label for="input-sizeA1" class="col-3 col-form-label col-form-label-sm">Размер А1</label>
            <div class="col-sm-2 input-group input-group-sm">
              <input name="sizeA1" class="form-control form-control-sm" id="input-sizeA1" type="text" readonly>
              <span class="input-group-addon">м</span>
            </div>
          </div>
          <div class="form-group row">
            <label for="input-sizeB1" class="col-3 col-form-label col-form-label-sm">Размер B1</label>
            <div class="col-sm-2 input-group input-group-sm">
              <input name="sizeB1" class="form-control form-control-sm" id="input-sizeB1" type="text" readonly>
              <span class="input-group-addon">м</span>
            </div>
          </div>
        </fieldset>
      </form>
    </div>
  </div>
  <script>
  window.onload = function() {
    
    var model = {};

    const POWER = {
          'tp1': {
            'to1':136,
            'to2':170
            },
          'tp2': {
            'to1':170,
            'to2':190
        }
    };
    const STEP = [0.075, 0.0875, 0.1, 0.1125, 0.125];
    const POWER_LENGTH = [
      [300, 17.6],
      [400, 23.5],
      [500, 29.4],
      [600, 35.3],
      [700, 41.2],
      [850, 50],
      [1000, 58.8],
      [1250, 73.5],
      [1400, 82.3],
      [1750, 102.9],
      [2200, 129.4],
      [2600, 156],
      [3100, 185]
      ];
  
    function getPower(tp, to) {
      return POWER[tp][to];
    }
    
    function nearestStep(value) {
      var min = 1;
      var index = 0;
      for(var i = 0; i < STEP.length; i++) {
        var cur = Math.abs(value - STEP[i]);
        if (min > cur) {
          min = cur;
          index = i;
        }
      }
      return STEP[index];
    }
  
    // ближайшее меньшее четное
    function nearestEven(value) {
      if (value == 0) return 0;
      var min = Math.floor(value - 1);
      var max = Math.ceil(value - 1);
      return max % 2 == 0 ? max : min;
    }
    
/*     for(var i=0; i<10; i+=0.1)
      console.log(i + "~" + nearestEven(i)); */
    
    function nearestPower(value) {
      var index = 0;
      if (value <= POWER_LENGTH[0][0]) {
        return POWER_LENGTH[0];
      }
      if (value >= POWER_LENGTH[POWER_LENGTH.length - 1][0]) {
        return POWER_LENGTH[POWER_LENGTH.length - 1];
      }
      for(var i = 0; i < POWER_LENGTH.length; i++) {
      var powerMin = POWER_LENGTH[i][0];
      var powerMax = POWER_LENGTH[i + 1][0];
      if (value >= powerMin && value < powerMax) {
        index = value < powerMin * 1.09 ? i : i + 1;
        return POWER_LENGTH[index];
      }
      }
    }
    
/*     for(var i=0; i<10000; i+=100)
      console.log(i + "~" + nearestPower(i)); */
    
      $(document).on("submit", false);
      
    $('.calculate-first').click(function(e) {
      calculateFirst();
            calculateSecond();
    });
    
        $('.calculate-third').click(function(e) {
            calculateThird();
        });
  
    function calculateFirst() {
      model.size1 = true;
      var tipPom = $('select[name=tipPom]').val();
      var tipObo = $('select[name=tipObo]').val();
      if (tipPom === null || tipObo === null) return;
      model.p = getPower(tipPom, tipObo);
      console.log("p=" + model.p);
      // --------------------------
      var a = $('input[name=a]').val();
      model.a = parseFloat(a == '' ? 0 : a);
      var b = $('input[name=b]').val();
      model.b = parseFloat(b == '' ? 0 : b);
      if (model.a == 0 || model.b == 0) return;
      var a1 = $('input[name=a1]').val();
      model.a1 = parseFloat(a1 == '' ? 0 : a1);
      var b1 = $('input[name=b1]').val();
      model.b1 = parseFloat(b1 == '' ? 0 : b1);
      if (model.a1 == 0 || model.b1 == 0) model.size1 = false;
      var S = a * b + a1 * b1;
      model.S = parseFloat(S.toFixed(2));
      $('input[name=S]').val(model.S);
      // ------------------------------
      var recPow = model.S * model.p;
      var powerLength = nearestPower(recPow);
      var P = powerLength[0];
      model.P = P;
      $('input[name=P]').val(P.toFixed(0)); // фактическая мощность
      var L = powerLength[1];
      model.L = L;
      $('input[name=L]').val(L); // фактическая длина кабеля
    }
    
    function calculateSecond() {
      // ------------------------------
      var p1 = $('input[name=p1]').val(); // вынос кабеля за ленту
      model.p1 = parseFloat(p1);
      var p2 = $('input[name=p2]').val(); // отступ ленты от А
      model.p2 = parseFloat(p2);
      var p3 = $('input[name=p3]').val(); // отступ ленты от С
      model.p3 = parseFloat(p3);
      var p4 = (model.b - model.p2 - model.p3) / 0.6 + 1;
      model.p4 = Math.ceil(p4);
      $('input[name=p4]').val(model.p4); // число полос ленты
          var p5 = (model.b - model.p2 - model.p3) / (model.p4 - 1)
          p5 = p5.toFixed(2);
          $('input[name=p5]').val(p5); // шаг укладки ленты
            var q = model.S / model.L;
            q = nearestStep(q);
            $('input[name=q]').val(q.toFixed(3)); // шаг укладки кабеля
            var k = model.a / q + 1;
            k = nearestEven(k);
            $('input[name=k]').val(k); // число полос кабеля
            if (model.size1) {
              var k1 = model.a1 / q + 1;
                k1 = nearestEven(k1);
                $('input[name=k1]').val(k1); // число полос кабеля
            }
    }
    
    function calculateThird() {      
      var q = $('input[name=q]').val(); // шаг укладки кабеля
      q = parseFloat(q);
          var k = $('input[name=k]').val(); // число полос кабеля
          k = parseFloat(k); 
      var L1 = model.L * model.a * model.b / model.S + 0.7; // длина кабеля для зоны обогрева
      console.log("L1=" + L1);
      var l = (L1 - model.a - q * 0.5 * k) / k;
      l = parseFloat(l.toFixed(2));
      $('input[name=l]').val(l); // длина полосы кабеля
      // ------------------------------
      var sizeA = (k - 1) * q;
      sizeA = sizeA.toFixed(2);
      $('input[name=sizeA]').val(sizeA); // размер
      var sizeB = l + 0.1;
      sizeB = sizeB.toFixed(2);
      $('input[name=sizeB]').val(sizeB); // размер
      // ------------------------------
      if (model.size1) {
          var k1 = $('input[name=k1]').val(); // число полос кабеля
          k1 = parseFloat(k1);
              var L2 = model.L - L1; // длина кабеля для зоны обогрева 2
              console.log("L2=" + L2);
          var l1 = (L2 - model.a1 - q * 0.5 * k1) / k1;
          l1 = parseFloat(l1.toFixed(2));
          $('input[name=l1]').val(l1); // длина полосы кабеля
          var sizeA1 = k1 * q;
          sizeA1 = sizeA1.toFixed(2);
          $('input[name=sizeA1]').val(sizeA1); // размер
          var sizeB1 = l1 + 0.1;
          sizeB1 = sizeB1.toFixed(2);
          $('input[name=sizeB1]').val(sizeB1); // размер
      }
    }
  }
  </script>
</body>
</html>